<div class="min-h-screen bg-gradient-to-br from-[#0f172a] to-[#1e293b] text-slate-100 py-8">
  <div class="mx-auto max-w-7xl px-4">

    <section class="rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 backdrop-blur-sm shadow-xl mb-8">
      <div class="p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">
              Felhasználókezelés
            </h1>
          </div>

          <div class="flex items-center gap-4 text-sm text-slate-300">
            <span class="inline-flex items-center gap-2 rounded-lg bg-slate-700/40 px-3 py-1.5 backdrop-blur-sm">
              <i class="bi bi-people-fill text-amber-400"></i>
              <span class="font-semibold">{{ users.length }}</span> felhasználó
            </span>
            <span class="inline-flex items-center gap-2 rounded-lg bg-slate-700/40 px-3 py-1.5 backdrop-blur-sm">
              <i class="bi bi-slash-circle text-rose-400"></i>
              <span class="font-semibold">{{ bannedUsersCount() }}</span> tiltva
            </span>
          </div>
        </div>
      </div>
    </section>

    <section class="rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 backdrop-blur-sm shadow-xl overflow-hidden">

      <div class="border-b border-slate-600/30 p-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div class="relative w-full sm:w-64">
            <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            <input 
              type="text" 
              placeholder="Keresés..."
              class="w-full pl-9 pr-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-sm text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-amber-400/30 backdrop-blur-sm"
              (input)="onSearch($event)">
          </div>

          <div class="flex flex-wrap gap-2">
            <select class="bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/30 backdrop-blur-sm"
                    (change)="onFilterChange($event)">
              <option value="all">Összes felhasználó</option>
              <option value="active">Aktív</option>
              <option value="banned">Tiltott</option>
              <option value="permanent">Véglegesen tiltott</option>
            </select>

            <select class="bg-slate-700/50 border border-slate-600 rounded-lg px-3 py-2 text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-amber-400/30 backdrop-blur-sm"
                    (change)="onSortChange($event)">
              <option value="recent">Legújabb</option>
              <option value="oldest">Legrégebbi</option>
              <option value="name">Név szerint</option>
            </select>
          </div>
        </div>
      </div>

      <div *ngIf="errorMessage" 
           class="m-4 rounded-lg border border-rose-400/30 bg-rose-500/10 p-4 text-rose-300 backdrop-blur-sm">
        <i class="bi bi-exclamation-circle-fill mr-2"></i>
        {{ errorMessage }}
      </div>

      <div *ngIf="loading" class="flex flex-col items-center justify-center py-12 text-slate-400">
        <i class="bi bi-arrow-repeat animate-spin text-4xl mb-3"></i>
        <p>Felhasználók betöltése...</p>
      </div>

      <div *ngIf="!loading" class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-700/40 text-left text-sm text-slate-300 backdrop-blur-sm">
            <tr>
              <th class="p-4 font-medium">Felhasználó</th>
              <th class="p-4 font-medium">Elérhetőség</th>
              <th class="p-4 font-medium">Hely</th>
              <th class="p-4 font-medium">Regisztráció</th>
              <th class="p-4 font-medium">Státusz</th>
              <th class="p-4 font-medium text-right">Műveletek</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-600/30">
            <tr *ngFor="let user of filteredUsers" 
                class="hover:bg-slate-700/20 transition-colors duration-200">
              
              <td class="p-4">
                <div class="flex items-center gap-3">
                  <div class="relative">
                    <div class="h-10 w-10 overflow-hidden rounded-full ring-2 ring-slate-600">
                      <ng-container *ngIf="user.profileImage; else initials">
                        <img [src]="apiUrl + user.profileImage"
                             alt="Profilkép" class="h-full w-full object-cover" />
                      </ng-container>
                      <ng-template #initials>
                        <div class="grid h-full w-full place-items-center bg-gradient-to-br from-amber-600 to-orange-600 text-sm font-bold">
                          {{ getInitials(user.username) }}
                        </div>
                      </ng-template>
                    </div>
                    <div class="absolute -bottom-1 -right-1 h-3 w-3 rounded-full border-2 border-slate-800"
                         [ngClass]="isUserActive(user) ? 'bg-emerald-400' : 'bg-slate-500'"></div>
                  </div>

                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <div class="font-semibold text-slate-100 truncate max-w-[120px]">{{ user.username }}</div>
                      <span *ngIf="user.verified"
                            class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-gradient-to-r from-emerald-500/20 to-green-500/20 px-2 py-0.5 text-xs text-emerald-300">
                        <i class="bi bi-patch-check-fill text-xs"></i>
                      </span>
                    </div>
                    <!-- <p class="text-xs text-slate-400 truncate max-w-[120px]">
                      {{ user.firstName || '—' }} {{ user.lastName || '—' }}
                    </p> -->
                  </div>
                </div>
              </td>

              <td class="p-4">
                <div class="space-y-1">
                  <div class="flex items-center gap-2 text-sm text-slate-300">
                    <i class="bi bi-envelope text-amber-400 text-xs"></i>
                    <span class="truncate max-w-[160px]">{{ user.email }}</span>
                  </div>
                  <!-- <div *ngIf="user.lastLogin" class="flex items-center gap-2 text-xs text-slate-400">
                    <i class="bi bi-clock text-orange-400"></i>
                    {{ user.lastLogin | date:'MMM dd, HH:mm' }}
                  </div> -->
                </div>
              </td>

              <td class="p-4">
                <div class="flex items-center gap-2 text-sm text-slate-300">
                  <i class="bi bi-geo-alt text-amber-400"></i>
                  <span>{{ user.country || '—' }}</span>
                </div>
              </td>

              <td class="p-4">
                <div class="text-sm text-slate-300">
                  {{ user.date | date:'yyyy.MM.dd' }}
                </div>
                <div class="text-xs text-slate-400">
                  {{ getDaysSince(user.date) }} napja
                </div>
              </td>

              <td class="p-4">
                <div class="flex flex-col gap-1">
                  <span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-full w-fit"
                    [ngClass]="{
                      'bg-emerald-500/20 text-emerald-300 border border-emerald-400/30': !isAnyBanActive(user),
                      'bg-rose-500/20 text-rose-300 border border-rose-400/30': isBanned(user),
                      'bg-red-500/20 text-red-300 border border-red-400/30': isPermanent(user)
                    }">
                    <i class="bi" 
                       [class.bi-check-circle]="!isAnyBanActive(user)"
                       [class.bi-slash-circle]="isBanned(user)"
                       [class.bi-shield-lock]="isPermanent(user)"></i>
                    {{ getStatusLabel(user) }}
                  </span>

                  <span *ngIf="isBanned(user) && !isPermanent(user)" 
                        class="text-xs text-rose-400/80">
                    {{ user.bannedUntil | date:'MMM dd, HH:mm' }}
                  </span>
                </div>
              </td>

              <td class="p-4">
                <div class="flex justify-end gap-2">
                  <button [routerLink]="['/profile', user.username]"
                          class="rounded-lg border border-slate-600 bg-slate-700/50 p-2 text-slate-300 hover:bg-slate-600/50 transition-all backdrop-blur-sm"
                          title="Profil megtekintése">
                    <i class="bi bi-person"></i>
                  </button>

                  <button
                    (click)="toggleBan(user)"
                    [ngClass]="isAnyBanActive(user) ? 
                      'bg-emerald-600 hover:bg-emerald-500 text-white' : 
                      'bg-rose-600 hover:bg-rose-500 text-white'"
                    class="rounded-lg px-3 py-2 text-sm font-medium transition-all backdrop-blur-sm flex items-center gap-2">
                    <i class="bi" 
                       [class.bi-unlock]="isAnyBanActive(user)"
                       [class.bi-lock]="!isAnyBanActive(user)"></i>
                    {{ isAnyBanActive(user) ? 'Feloldás' : 'Tiltás' }}
                  </button>

                  <div class="relative" *ngIf="!isAnyBanActive(user)">
                    <button
                      (click)="toggleDropdown(user._id)"
                      class="rounded-lg border border-slate-600 bg-slate-700/50 p-2 text-slate-300 hover:bg-slate-600/50 transition-all backdrop-blur-sm"
                      title="Gyors tiltási opciók">
                      <i class="bi bi-three-dots"></i>
                    </button>

                    <div *ngIf="openDropdownFor === user._id"
                        class="absolute right-0 top-full mt-1 w-48 rounded-lg border border-slate-600 bg-slate-800/95 p-2 shadow-xl backdrop-blur-sm z-10">
                      <button (click)="quickBan(user, '1d')" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 hover:bg-slate-700/50 transition-colors">
                        <i class="bi bi-clock text-amber-400"></i> 1 napos tiltás
                      </button>
                      <button (click)="quickBan(user, '1m')" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-300 hover:bg-slate-700/50 transition-colors">
                        <i class="bi bi-calendar-month text-orange-400"></i> 1 hónapos tiltás
                      </button>
                      <button (click)="quickBan(user, 'permanent')" class="flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-rose-300 hover:bg-rose-500/20 transition-colors">
                        <i class="bi bi-shield-lock text-rose-400"></i> Végleges tiltás
                      </button>
                      <button (click)="toggleRole(user)"
                              class="mt-1 flex w-full items-center gap-2 rounded-lg px-3 py-2 text-sm text-slate-200 hover:bg-slate-700/50 transition-colors border-t border-slate-700/60 pt-2">
                        <i class="bi bi-shield-lock-fill"
                          [ngClass]="user.role === 'admin' ? 'text-amber-400' : 'text-slate-400'"></i>
                        <span>
                          {{ user.role === 'admin' ? 'Admin jog visszavonása' : 'Admin jogosultság adása' }}
                        </span>
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="filteredUsers.length === 0 && !loading" 
             class="flex flex-col items-center justify-center py-12 text-center">
          <div class="w-20 h-20 rounded-full bg-slate-700/40 flex items-center justify-center mb-4 backdrop-blur-sm">
            <i class="bi bi-people text-4xl text-slate-400"></i>
          </div>
          <h4 class="text-lg font-semibold text-slate-200 mb-2">Nincsenek felhasználók</h4>
          <p class="text-sm text-slate-300 max-w-md">
            {{ searchTerm ? 'A keresésnek megfelelő felhasználó nem található' : 'Még nincsenek felhasználók az adatbázisban' }}
          </p>
        </div>
      </div>

      <div *ngIf="filteredUsers.length > 0" class="border-t border-slate-600/30 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-400">
            Megjelenítve: <span class="text-slate-200 font-medium">{{ filteredUsers.length }}</span> felhasználó
          </div>
          
          <div class="flex items-center gap-1 bg-slate-700/40 rounded-lg p-1 backdrop-blur-sm">
            <button class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-slate-600/50 transition-colors text-slate-400 hover:text-slate-200">
              <i class="bi bi-chevron-left"></i>
            </button>
            <button class="w-8 h-8 flex items-center justify-center rounded-md bg-amber-600 text-white text-sm font-medium">1</button>
            <button class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-slate-600/50 transition-colors text-slate-400 hover:text-slate-200">2</button>
            <button class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-slate-600/50 transition-colors text-slate-400 hover:text-slate-200">3</button>
            <button class="w-8 h-8 flex items-center justify-center rounded-md hover:bg-slate-600/50 transition-colors text-slate-400 hover:text-slate-200">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <div *ngIf="toast.text" 
         [class]="'fixed bottom-20 left-1/2 z-50 -translate-x-1/2 transform transition-all duration-300 rounded-xl border px-4 py-3 shadow-lg ' + 
                  (toast.variant === 'success' ? 'bg-emerald-900/90 text-emerald-100 border-emerald-700' : 
                   toast.variant === 'error' ? 'bg-rose-900/90 text-rose-100 border-rose-700' : 
                   'bg-slate-900/90 text-slate-100 border-slate-700')">
      <div class="flex items-center gap-2">
        <i *ngIf="toast.variant === 'success'" class="bi bi-check-circle-fill text-emerald-400"></i>
        <i *ngIf="toast.variant === 'error'" class="bi bi-exclamation-circle-fill text-rose-400"></i>
        {{ toast.text }}
      </div>
    </div>
  </div>
</div>