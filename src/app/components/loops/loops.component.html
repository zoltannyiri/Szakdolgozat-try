<div class="w-full px-4 sm:px-[15%] bg-indigo-50 min-h-screen">
  <br>
  <div class="w-full max-w-3xl mx-auto">
    <!-- Search Bar -->
    <div class="flex flex-col sm:flex-row justify-between gap-4 sm:gap-0">
      <!-- Upload Loop Button -->
      <button (click)="toggleUploadModal()"
        class="w-full sm:w-auto bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-transform transform hover:scale-105 shadow-md flex items-center justify-center space-x-2 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
            clip-rule="evenodd" />
        </svg>
        <span class="text-sm">Upload Loop</span>
      </button>

      <!-- Search Input -->
      <div class="relative w-full sm:w-1/2">
        <input type="text" [(ngModel)]="searchQuery" (keyup.enter)="searchLoops()" placeholder="Search loops..."
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition pl-10">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-3.5 text-gray-400"
          viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
            clip-rule="evenodd" />
        </svg>
      </div>

      <!-- Advanced Search Button -->
      <button (click)="toggleAdvancedSearch()"
        class="w-full sm:w-auto bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition-transform transform hover:scale-105 shadow-md flex items-center justify-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
            clip-rule="evenodd" />
        </svg>
        <span class="text-sm sm:text-base">Advanced Search</span>
      </button>
    </div>
  </div>

  <!-- Upload Modal -->
  <div *ngIf="isUploadModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    (click)="closeUploadModal($event)">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl mx-4 relative">
      <button (click)="toggleUploadModal()"
        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl bg-gray-100 hover:bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center transition">
        &times;
      </button>

      <h2 class="text-2xl font-bold mb-6 text-gray-800">Upload Loop</h2>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select a WAV file (max 20MB)</label>
        <input type="file" accept=".wav,.mp3,.aiff" (change)="onFileSelected($event)"
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        <p *ngIf="fileError" class="text-red-500 text-sm mt-2">{{ fileError }}</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">BPM</label>
          <input type="number" [(ngModel)]="metadata.bpm" min="40" max="300"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Key</label>
          <select [(ngModel)]="metadata.key"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="" disabled selected>Select key</option>
            <option *ngFor="let k of keys" [value]="k">{{ k }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Scale</label>
          <select [(ngModel)]="metadata.scale"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option *ngFor="let scale of scales" [value]="scale">{{ scale }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Instrument</label>
          <select [(ngModel)]="metadata.instrument"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="" disabled selected>Select instrument</option>
            <option *ngFor="let instrument of instruments" [value]="instrument">{{ instrument }}</option>
          </select>
        </div>
      </div>

      <div class="mb-4" *ngIf="selectedFile">
        <label class="block text-sm font-medium text-gray-700 mb-2">Loop neve (elhagyható)</label>
        <input type="text" [(ngModel)]="metadata.customName" placeholder="Egyedi név (opcionális)"
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Tags (comma separated)</label>
        <input type="text" [(ngModel)]="metadata.tags" placeholder="hiphop, trap, dark"
          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div>

      <div class="flex justify-end space-x-4">
        <button (click)="toggleUploadModal()"
          class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
          Cancel
        </button>
        <button (click)="uploadFile()" [disabled]="!selectedFile || isUploading"
          class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
          <span *ngIf="!isUploading">Upload</span>
          <span *ngIf="isUploading" class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            Uploading...
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Advanced Search Modal -->
  <div *ngIf="isAdvancedSearchOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
    (click)="closeAdvancedSearch($event)">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl mx-4 relative">
      <button (click)="toggleAdvancedSearch()"
        class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl bg-gray-100 hover:bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center transition">
        &times;
      </button>

      <h2 class="text-2xl font-bold mb-6 text-gray-800">Advanced Search</h2>

      <form (ngSubmit)="applyAdvancedSearch()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- BPM Range -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">BPM Range</label>
          <div class="flex space-x-4">
            <input type="number" [(ngModel)]="filters.minBpm" name="minBpm" placeholder="Min" min="40" max="300"
              class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <input type="number" [(ngModel)]="filters.maxBpm" name="maxBpm" placeholder="Max" min="40" max="300"
              class="w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
        </div>

        <!-- Key -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Key</label>
          <select [(ngModel)]="filters.key" name="key"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="">Any Key</option>
            <option *ngFor="let k of keys" [value]="k">{{ k }}</option>
          </select>
        </div>

        <!-- Scale -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Scale</label>
          <select [(ngModel)]="filters.scale" name="scale"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="">Any Scale</option>
            <option *ngFor="let scale of scales" [value]="scale">{{ scale }}</option>
          </select>
        </div>

        <!-- Instrument -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Instrument</label>
          <select [(ngModel)]="filters.instrument" name="instrument"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="">Any Instrument</option>
            <option *ngFor="let instrument of instruments" [value]="instrument">{{ instrument }}</option>
          </select>
        </div>

        <!-- Tags -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
          <input type="text" [(ngModel)]="filters.tags" name="tags" placeholder="hiphop, trap, dark"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
        </div>

        <!-- Sort By -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
          <select [(ngModel)]="filters.sortBy" name="sortBy"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="recent">Most Recent</option>
            <option value="downloads">Most Downloaded</option>
            <option value="likes">Most Liked</option>
          </select>
        </div>

        <!-- Search Button -->
        <div class="flex items-end col-span-full">
          <button type="submit"
            class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-md">
            Apply Filters
          </button>
        </div>
      </form>
    </div>
  </div>

  <br>
  <hr class="vonal border-t-2 my-8 border-black">

  <!-- Loops List -->
  <div class="w-full max-w-6xl mx-auto">
    <div *ngIf="isLoading" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    </div>

    <div *ngIf="!isLoading && loops.length === 0" class="text-center py-12">
      <p class="text-gray-500">No loops found. Try adjusting your search filters.</p>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div *ngFor="let loop of loops" class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition">
        <div class="p-4">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-bold text-lg hover:text-blue-600 cursor-pointer"
                [routerLink]="['/loop-detail', loop._id]">{{ loop.filename }}</h3>
              <p class="text-gray-600 text-sm">{{ loop.instrument }}</p>
            </div>
            <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded">{{ loop.bpm }} BPM</span>
          </div>
          <div class="mt-2 flex flex-wrap gap-1">
            <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">{{ loop.key }} {{ loop.scale }}</span>
            <span *ngFor="let tag of loop.tags" class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">{{ tag
              }}</span>
          </div>
        </div>
        <div class="px-4 pb-4">
          <div class="relative">
            <audio #audioPlayer controls class="w-full" (play)="onAudioPlay()" (pause)="onAudioPause()"
  (error)="onAudioError(audioPlayer)">
  <source [src]="getSafeAudioUrl(loop.path)" type="audio/mpeg">
  A böngésződ nem támogatja a hanglejátszást.
</audio>
            <div *ngIf="!loop?.path" class="bg-gray-100 p-3 text-center text-gray-500 rounded">
              Audio file not available
            </div>
          </div>

          <!-- Custom Audio Controls -->
          <div class="mt-2 flex items-center space-x-2">
            <button (click)="togglePlay(getNativeElement(audioPlayer))" class="text-indigo-600 hover:text-indigo-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" [class.text-indigo-600]="!isPlaying"
                [class.text-gray-400]="isPlaying" viewBox="0 0 20 20" fill="currentColor">
                <path *ngIf="!isPlaying" fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                  clip-rule="evenodd" />
                <path *ngIf="isPlaying" fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd" />
              </svg>
            </button>

            <button (click)="testAudioPlayback()" class="bg-blue-500 text-white p-2 rounded">
              Teszt hangfájl lejátszása
            </button>
            <div class="flex-1 bg-gray-200 rounded-full h-2">
              <div class="bg-indigo-600 h-2 rounded-full"
                [style.width.%]="audioPlayer ? getProgress(getNativeElement(audioPlayer)) : 0"></div>
            </div>
            <span class="text-xs text-gray-500">
              {{ audioPlayer ? formatTime(getCurrentTime(getNativeElement(audioPlayer))) : '0:00' }} /
              {{ audioPlayer ? formatTime(getDuration(getNativeElement(audioPlayer))) : '0:00' }}
            </span>
          </div>

          <!-- Rest of your template remains the same -->
        </div>
      </div>
    </div>
  </div>
</div>