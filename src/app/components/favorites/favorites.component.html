<div class="min-h-screen bg-gradient-to-br from-[#0f172a] to-[#1e293b] text-slate-100 relative">
  <div class="pointer-events-none absolute inset-0 opacity-[0.03] [background-image:url('https://grainy-gradients.vercel.app/noise.svg')]"></div>

  <div class="relative mx-auto max-w-7xl px-3 py-4 sm:px-4 sm:py-8">
    <section class="mb-6 sm:mb-8 rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 backdrop-blur-sm p-4 sm:p-6 shadow-xl">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="grid h-8 w-8 sm:h-10 sm:w-10 place-items-center rounded-xl bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg">
            <i class="bi bi-heart-fill text-sm sm:text-lg"></i>
          </div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold tracking-tight text-slate-100">Kedvenc loopjaid</h1>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-600/50 bg-slate-700/50 px-3 py-1.5 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium text-slate-300 backdrop-blur-sm">
          Összesen: <span class="font-semibold text-amber-300">{{ favoriteLoops.length }}</span>
        </div>
      </div>
    </section>

    <div *ngIf="isLoading" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
      <div *ngFor="let i of [0,1,2,3,4,5]" 
           class="rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 p-6 shadow-xl backdrop-blur-sm animate-pulse">
        <div class="mb-5 h-20 rounded-xl bg-slate-700/40"></div>
        <div class="mb-3 h-6 w-2/3 rounded bg-slate-700/40"></div>
        <div class="h-4 w-1/3 rounded bg-slate-700/40"></div>
        <div class="mt-5 h-10 rounded-xl bg-slate-700/40"></div>
      </div>
    </div>

    <div *ngIf="!isLoading && favoriteLoops.length === 0" 
         class="rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 p-8 sm:p-12 text-center shadow-xl backdrop-blur-sm">
      <div class="mx-auto mb-4 h-16 w-16 sm:h-20 sm:w-20 rounded-2xl bg-slate-700/40 flex items-center justify-center backdrop-blur-sm">
        <i class="bi bi-heart text-3xl sm:text-4xl text-slate-400"></i>
      </div>
      <h3 class="mb-2 text-lg font-semibold text-slate-200">Nincs kedvenc</h3>
      <p class="text-sm text-slate-400">Jelölj kedvencnek loopokat a galériában.</p>
      <a [routerLink]="['/loops']" 
         class="mt-6 inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-amber-600 to-orange-600 px-6 py-3 text-sm font-semibold text-white shadow-lg transition-all hover:from-amber-500 hover:to-orange-500 hover:shadow-amber-500/25">
        <i class="bi bi-music-note-beamed"></i>
        Felfedezés
      </a>
    </div>

    <div *ngIf="!isLoading && favoriteLoops.length > 0" class="space-y-4 sm:space-y-6">
      <div *ngFor="let loop of favoriteLoops; trackBy: trackById" 
           class="group rounded-2xl border border-slate-600/30 bg-gradient-to-b from-slate-800/80 to-slate-900/80 p-4 sm:p-6 shadow-xl transition-all duration-300 hover:border-slate-500/50 hover:bg-slate-800/60 backdrop-blur-sm">

        <audio #audioPlayer
          [id]="'fav-audio-' + loop._id"
          [src]="getAudioUrl(loop.path) || ''"
          hidden
          (play)="onAudioPlay(loop._id)"
          (pause)="onAudioPause()"
          (error)="onAudioError(audioPlayer)"
          (timeupdate)="updateProgress(loop._id)">
        </audio>

        <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row sm:items-start justify-between gap-4">
          <div class="flex-1 w-full">
            <div class="mb-3 flex flex-wrap items-center gap-2 sm:gap-3">
              <h3 class="cursor-pointer text-lg sm:text-xl font-semibold tracking-tight text-slate-100 transition-colors hover:text-amber-400 break-all"
                  [routerLink]="['/loop-detail', loop._id]">
                {{ loop.filename || 'Untitled Loop' }}
              </h3>
              <span *ngIf="loop.bpm" 
                    class="rounded-full bg-amber-500/20 px-2.5 py-0.5 sm:px-3 sm:py-1 text-[10px] sm:text-xs font-mono font-medium text-amber-300 ring-1 ring-inset ring-amber-400/30 whitespace-nowrap">
                {{ loop.bpm }} BPM
              </span>
            </div>
            <div class="flex flex-wrap items-center gap-3 sm:gap-4 text-xs sm:text-sm text-slate-400">
              <span *ngIf="loop.instrument" class="inline-flex items-center gap-1.5 sm:gap-2">
                <i class="bi bi-speedometer2 text-amber-400"></i>
                {{ loop.instrument }}
              </span>
              <span *ngIf="loop.key || loop.scale" class="inline-flex items-center gap-1.5 sm:gap-2">
                <i class="bi bi-music-note text-orange-400"></i>
                {{ loop.key }} {{ loop.scale }}
              </span>
            </div>
          </div>

          <div class="flex items-center justify-between sm:justify-end gap-3 w-full sm:w-auto">
            <div class="flex items-center gap-3">
              <button (click)="toggleLike(loop)"
                      class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-transparent hover:bg-transparent focus:bg-transparent active:bg-transparent focus:outline-none outline-none focus:ring-0 appearance-none relative">
                <i class="bi text-lg"
                   [class.bi-heart]="!hasLiked(loop)"
                   [class.bi-heart-fill]="hasLiked(loop)"
                   [ngClass]="hasLiked(loop) ? 'text-rose-500' : 'text-slate-400'">
                </i>
              </button>
              <span class="text-sm text-slate-400">{{ loop.likes || 0 }}</span>

              <button (click)="removeFavorite(loop._id!)"
                      class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-transparent hover:bg-transparent focus:bg-transparent active:bg-transparent focus:outline-none outline-none focus:ring-0 appearance-none">
                <i class="bi bi-star-fill text-lg text-amber-500"></i>
              </button>

              <button (click)="downloadLoop(loop)" 
                      class="rounded-full p-2.5 text-slate-400 transition-all hover:bg-emerald-500/20 hover:text-emerald-400 backdrop-blur-sm"
                      title="Loop letöltése">
                <i class="bi bi-download text-sm"></i>
              </button>

              <ng-container *ngIf="!isAdmin">
                <button (click)="openLoopReportModal(loop._id!)"
                        class="rounded-full p-2.5 text-slate-400 transition-all hover:bg-rose-500/20 hover:text-rose-400 backdrop-blur-sm"
                        title="Loop jelentése">
                  <i class="bi bi-flag text-sm"></i>
                </button>
              </ng-container>
              <ng-container *ngIf="isAdmin">
                <button (click)="adminDeleteLoop(loop)"
                        class="rounded-full p-2.5 text-slate-400 transition-all hover:bg-rose-500/20 hover:text-rose-400 backdrop-blur-sm"
                        title="Loop törlése">
                  <i class="bi bi-trash text-sm"></i>
                </button>
                <button (click)="openEditModal(loop)"
                        class="rounded-full p-2.5 text-slate-400 transition-all hover:bg-slate-600/50 hover:text-slate-200 backdrop-blur-sm"
                        title="Loop módosítása">
                  <i class="bi bi-pencil text-sm"></i>
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <div *ngIf="loop.tags?.length" class="mb-4 sm:mb-6 flex flex-wrap gap-2">
          <span *ngFor="let tag of loop.tags" 
                class="rounded-full bg-slate-700/50 px-2.5 py-0.5 sm:px-3 sm:py-1 text-[10px] sm:text-xs text-slate-300 ring-1 ring-inset ring-slate-600/50 backdrop-blur-sm hover:bg-slate-600/50 transition-colors">
            <i class="bi bi-tag-fill mr-1 text-amber-400"></i>{{ tag }}
          </span>
        </div>

        <div class="rounded-xl border border-slate-600/30 bg-slate-800/40 p-3 sm:p-4 backdrop-blur-sm">
          <div class="relative mb-4 h-16 sm:h-20 cursor-pointer overflow-hidden rounded-lg bg-slate-700/30 ring-1 ring-inset ring-slate-600/30" 
               (click)="seekAudio($event, loop._id!, true)">
            <div class="absolute inset-0 flex items-center opacity-60">
              <div class="flex h-8 w-full items-end">
                <div *ngFor="let v of waveforms[loop._id!] || []"
                     class="flex-1 mx-[0.5px] sm:mx-0.5 rounded-sm bg-slate-500 transition-all duration-100"
                     [style.height.%]="v * 0.8"></div>
              </div>
            </div>
            <div class="absolute inset-0 flex items-center overflow-hidden" [style.width.%]="getProgress(loop._id!)">
              <div class="flex h-8 items-end">
                <div *ngFor="let v of waveforms[loop._id!] || []"
                     class="flex-1 mx-[0.5px] sm:mx-0.5 rounded-sm bg-amber-400 transition-all duration-100"
                     [style.height.%]="v * 0.8"></div>
              </div>
            </div>
            <div class="absolute top-0 bottom-0 ml-1 w-0.5 bg-amber-400" [style.left.%]="getProgress(loop._id!)"></div>
          </div>

          <div class="flex items-center justify-between gap-2 sm:gap-4">
            <button (click)="togglePlay(loop._id!, audioPlayer)"
                    class="flex h-10 w-10 sm:h-12 sm:w-12 items-center justify-center rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-lg transition-all hover:scale-105 hover:shadow-amber-500/40 group flex-shrink-0">
              <i class="bi text-lg transition-transform group-hover:scale-110" 
                 [class.bi-play-fill]="currentlyPlayingId !== loop._id" 
                 [class.bi-pause-fill]="currentlyPlayingId === loop._id"></i>
            </button>

            <div class="flex flex-1 items-center">
              <span class="w-8 sm:w-10 font-mono text-[10px] sm:text-xs text-slate-400 text-right">{{ formatTime(currentPositions[loop._id!]) }}</span>
              <div class="relative mx-2 h-2 flex-1 cursor-pointer overflow-hidden rounded-full bg-slate-700/50" 
                   (click)="seekAudio($event, loop._id!, false)">
                <div class="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-amber-500 via-orange-500 to-amber-400" 
                     [style.width.%]="getProgress(loop._id!)"></div>
                <div class="absolute top-0 bottom-0 w-0.5 rounded-full bg-slate-100/80" 
                     [style.left.%]="getProgress(loop._id!)"></div>
              </div>
              <span class="w-8 sm:w-10 font-mono text-[10px] sm:text-xs text-slate-400">{{ formatTime(durations[loop._id!]) }}</span>
            </div>

            <div class="hidden sm:flex items-center gap-3">
              <i class="bi bi-volume-up text-slate-400"></i>
              <input type="range" min="0" max="1" step="0.01" [value]="volumes[loop._id!] || 0.7" 
                     (input)="setVolume(loop._id!, $any($event.target).value)" 
                     class="ml-2 h-1 w-24 cursor-pointer appearance-none rounded-full bg-slate-700/50 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-amber-400" />
            </div>
          </div>
        </div>

        <div class="mt-4 sm:mt-5 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
          <a [routerLink]="['/loop-detail', loop._id!]"
             class="flex items-center justify-center gap-2 rounded-full border border-slate-600/50 bg-slate-700/50 px-4 py-2 text-sm font-medium text-slate-300 transition-all hover:bg-slate-600/50 backdrop-blur-sm">
            <i class="bi bi-info-circle"></i>
            Részletek
          </a>

          <div class="flex gap-2">
            <button (click)="downloadLoop(loop)"
                    class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-emerald-600 to-teal-600 px-4 py-2 text-sm font-semibold text-white transition-all hover:from-emerald-500 hover:to-teal-500">
              <i class="bi bi-download"></i>
              Letöltés
            </button>
            <button (click)="removeFavorite(loop._id!)"
                    class="flex-1 sm:flex-none inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-rose-600 to-pink-600 px-4 py-2 text-sm font-semibold text-white transition-all hover:from-rose-500 hover:to-pink-500">
              <i class="bi bi-star-fill"></i>
              Eltávolítás
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isLoopReportModalOpen"
         class="fixed inset-0 z-50 grid place-items-center bg-black/70 p-4 backdrop-blur-sm overflow-y-auto"
         (click)="closeLoopReportModal($event)">
      <div class="relative w-full max-w-md rounded-2xl border border-slate-700/50 bg-gradient-to-b from-slate-800 to-slate-900 p-4 sm:p-6 shadow-xl"
           (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-100">Loop jelentése</h3>
          <button (click)="isLoopReportModalOpen=false" class="rounded-full p-2 text-slate-400 hover:bg-slate-700/50 hover:text-slate-200 transition-all">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <p class="mb-3 text-sm text-slate-400">Kérlek írd le röviden, mi a probléma ezzel a looppal.</p>
        <textarea [(ngModel)]="loopReportReason" rows="5" maxlength="1000" 
                  class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 placeholder-slate-400 focus:border-rose-400/50 focus:ring-2 focus:ring-rose-400/20 backdrop-blur-sm"
                  placeholder="Részletek…"></textarea>
        <div *ngIf="loopReportError" class="mt-2 text-sm text-rose-400">{{ loopReportError }}</div>
        <div *ngIf="loopReportSuccess" class="mt-2 text-sm text-emerald-400">{{ loopReportSuccess }}</div>
        <div class="mt-4 flex justify-end gap-2">
          <button (click)="isLoopReportModalOpen=false" 
                  class="inline-flex items-center gap-2 rounded-full border border-slate-600/50 bg-slate-700/50 px-5 py-2.5 text-sm font-medium text-slate-300 transition-all hover:bg-slate-600/50 backdrop-blur-sm">
            Mégse
          </button>
          <button (click)="submitLoopReport()" [disabled]="isReportingLoop || !loopReportReason.trim()"
                  class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-rose-600 to-red-600 px-5 py-2.5 text-sm font-semibold text-white transition-all hover:from-rose-500 hover:to-red-500 disabled:opacity-50">
            {{ isReportingLoop ? 'Küldés…' : 'Jelentés elküldése' }}
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="isEditModalOpen"
         class="fixed inset-0 z-50 grid place-items-center bg-black/70 p-4 backdrop-blur-sm overflow-y-auto"
         (click)="closeEditModal($event)">
      <div class="relative w-full max-w-lg rounded-2xl border border-slate-700/50 bg-gradient-to-b from-slate-800 to-slate-900 p-4 sm:p-6 shadow-xl"
           (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-100">Loop módosítása</h3>
          <button (click)="isEditModalOpen=false" class="rounded-full p-2 text-slate-400 hover:bg-slate-700/50 hover:text-slate-200 transition-all">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <div class="space-y-4">
          <div>
            <label class="mb-1 block text-sm font-medium text-slate-300">Név</label>
            <input type="text" [(ngModel)]="editForm.name" 
                   class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm" />
          </div>
          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-300">BPM</label>
              <input type="number" [(ngModel)]="editForm.bpm" min="40" max="300" 
                     class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-300">Hangnem</label>
              <select [(ngModel)]="editForm.key" 
                      class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm">
                <option value="">—</option>
                <option *ngFor="let k of keys" [value]="k">{{ k }}</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-300">Skála</label>
              <select [(ngModel)]="editForm.scale" 
                      class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm">
                <option value="">—</option>
                <option *ngFor="let s of scales" [value]="s">{{ s }}</option>
              </select>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-300">Hangszer</label>
              <select [(ngModel)]="editForm.instrument" 
                      class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm">
                <option value="">—</option>
                <option *ngFor="let i of instruments" [value]="i">{{ i }}</option>
              </select>
            </div>
          </div>
          <div>
            <label class="mb-1 block text-sm font-medium text-slate-300">Címkék (vesszővel)</label>
            <input type="text" [(ngModel)]="editForm.tags" placeholder="hiphop, trap, dark" 
                   class="w-full rounded-xl border border-slate-600/50 bg-slate-700/50 p-3 text-slate-100 placeholder-slate-400 focus:border-amber-400/50 focus:ring-2 focus:ring-amber-400/20 backdrop-blur-sm" />
          </div>
          <div *ngIf="editError" class="text-sm text-rose-400">{{ editError }}</div>
        </div>

        <div class="mt-6 flex justify-end gap-2">
          <button (click)="isEditModalOpen=false" 
                  class="inline-flex items-center gap-2 rounded-full border border-slate-600/50 bg-slate-700/50 px-5 py-2.5 text-sm font-medium text-slate-300 transition-all hover:bg-slate-600/50 backdrop-blur-sm">
            Mégse
          </button>
          <button (click)="saveLoopEdit()" [disabled]="isSavingEdit"
                  class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-amber-600 to-orange-600 px-5 py-2.5 text-sm font-semibold text-white transition-all hover:from-amber-500 hover:to-orange-500 disabled:opacity-50">
            {{ isSavingEdit ? 'Mentés…' : 'Mentés' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="toast.text" 
     [class]="'fixed bottom-10 left-1/2 z-[100] -translate-x-1/2 transform transition-all duration-300 rounded-xl border px-6 py-3 shadow-2xl backdrop-blur-md ' + 
              (toast.variant === 'success' ? 'bg-emerald-900/90 text-emerald-100 border-emerald-500/50' : 
               toast.variant === 'error' ? 'bg-rose-900/90 text-rose-100 border-rose-500/50' : 
               'bg-slate-800/90 text-slate-100 border-slate-600/50')">
  <div class="flex items-center gap-3">
    <i *ngIf="toast.variant === 'success'" class="bi bi-check-circle-fill text-emerald-400 text-lg"></i>
    <i *ngIf="toast.variant === 'error'" class="bi bi-exclamation-triangle-fill text-rose-400 text-lg"></i>
    <span class="font-medium text-sm sm:text-base">{{ toast.text }}</span>
  </div>
</div>